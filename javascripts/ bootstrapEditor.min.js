/* ===================================================
 * bootstrap-editor.js v0.1
 * Rich Editor
 * ===================================================
 * Copyright (c) 2012 
 * Author - Sanket Bajoria
 * Email - bajoriasanket@gmail.com
 * Source - https://github.com/sanketbajoria/BootstrapEditor
 * Demo - http://sanketbajoria.github.com/BootstrapEditor
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */

(function(b){function a(){var c={};var i=null;var y=null;var n=null;var u=null;var h={};var x={};var v={};v.deleteTable=function(){var z=v.getTableProp();if(z&&z.node){b(z.node).remove()}};v.getTableProp=function(){var A=n.getRange();if(!A){return null}var z=b(A.commonAncestorContainer?A.commonAncestorContainer:A.parentElement());var D=parseInt(z.closest("tr").index());var B=parseInt(z.closest("td").index());var C=z.closest("table");return C.length>0?{node:C[0],rowLen:C[0].rows.length,colLen:C[0].rows[0].childNodes.length,rowIndex:D,colIndex:B}:null};v.insertRow=function(D){var C=v.getTableProp();if(C&&C.rowIndex>=0){var B=C.node.insertRow(D?C.rowIndex+1:C.rowIndex);for(var A=0;A<C.colLen;A++){var z=B.insertCell(A);z.innerHTML="&nbsp;"}}};v.deleteRow=function(){var A=v.getTableProp();if(A==null){return}if(A.rowLen==1){v.deleteTable();return}if(A.rowIndex>=0&&A.rowIndex<A.rowLen){var z=b(A.node.rows[A.rowIndex]).siblings("tr");A.node.deleteRow(A.rowIndex);n.selectNode(z[A.rowIndex<A.rowLen-1?A.rowIndex:A.rowIndex-1].cells[A.colIndex>=0?A.colIndex:0],true)}};v.deleteCol=function(){var B=v.getTableProp();if(B==null){return}if(B.colIndex>=0&&B.colIndex<B.colLen){if(B.colLen==1){v.deleteTable();return}var A=b(B.node.rows[B.rowIndex].cells[B.colIndex]).siblings("td");for(var z=0;z<B.rowLen;z++){B.node.rows[z].deleteCell(B.colIndex)}n.selectNode(A[B.colIndex<B.colLen-1?B.colIndex:B.colIndex-1],true)}};v.insertCol=function(B){var C=v.getTableProp();if(C&&C.colIndex>=0){for(var A=0;A<C.rowLen;A++){var z=C.node.rows[A].insertCell(B?C.colIndex+1:C.colIndex);z.innerHTML="&nbsp;"}}};v.insertRowBelow=function(){v.insertRow(true)};v.insertRowAbove=function(){v.insertRow(false)};v.insertColLeft=function(){v.insertCol(false)};v.insertColRight=function(){v.insertCol(true)};v.insertTable=function(){var z='<form><fieldset><label>No. of rows</label><input type="text" id="row" placeholder="rows"><label>No. of columns</label><input type="text" id="column" placeholder="columns"></fieldset></form>';var B="Insert",D=null,C=null;var A=o("bootstrapTableModal",null,z,B,function(){D=D||b("#row",A);C=C||b("#column",A);if(parseInt(b.trim(D.val()))<=0||parseInt(b.trim(C.val()))<=0){return}var E="<table id='test' cellspacing=0 cellpadding=0 border=1 style='border-color: #ccc'>";for(var G=0;G<parseInt(b.trim(D.val()));G++){E+="<tr>";for(var F=0;F<parseInt(b.trim(C.val()));F++){E+="<td>&nbsp;</td>"}E+="</tr>"}E+="</table>";n.insertNode(E)});D=b("#row",A);C=b("#column",A);D.val("");C.val("");A.modal("show")};var f=function(){var z='<form><fieldset><label>HTML Source Editor</label><textarea id="htmlSource" rows="15" style="width:100%"></textarea></fieldset></form>';var C="Update";var B=null;var A=o("bootstrapHtmlModal",null,z,C,function(){B=B||b("#htmlSource",A);var D="";var E=b("<div>"+B.val()+"</div>").contents().each(function(){if(this.nodeType===3){D+="<p>"+this.nodeValue+"</p>"}else{D+=b(this).wrap("<div/>").parent().html()}});n.frameDoc.body.innerHTML=D});B=b("#htmlSource",A);setTimeout(function(){B.val(n.frameDoc.body.innerHTML);A.modal("show")},200)};var l=function(){var z='<form><fieldset><label>Enter Image URL</label><input type="text" id="imageUrl" placeholder="Image URL"></fieldset></form>';var C="Insert";var B=null;var A=o("bootstrapImageModal",null,z,C,function(){B=B||b("#imageUrl",A);if(b.trim(B.val())===""){return}n.frameDoc.execCommand("insertImage",false,b.trim(B.val()))});B=b("#imageUrl",A);B.val("http://");A.modal("show")};var r=function(){var z='<form><fieldset><label>Address</label><input type="text" id="address" placeholder="URL/Mail"><label>Text to display</label><input type="text" id="text" placeholder="Text"></fieldset></form>';var B="Create";var A=null;var D=null;var C=o("bootstrapLinkModal",null,z,B,function(){var E=true;A=A||b("#address",C);D=D||b("#text",C);if(b.trim(A.val())===""||b.trim(D.val())===""){return}var F=n.frameDoc.createTextNode(b.trim(D.val()));n.replaceText(F);n.frameDoc.execCommand("createLink",false,b.trim(A.val()))});A=b("#address",C);D=b("#text",C);A.val("http://");D.val(n.getText());C.modal("show")};var j=function(E,D,A,B,z,C){this.command=E;this.value=D;this.tags=A;this.css=B;this.hotkey=z;this.execCmd=C};var d=function(A,C,E,D,F,B,z){this.icon=A;this.group=C;this.title=E;this.visible=D;this.wrapContent=F;this.action=B;this.subMenu=z};var o=function(E,D,z,A,C){if(E in x){return x[E]}var B='<div id="'+E+'" class="modal hide fade" tabindex="-1">';if(D){B+='<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>';B+="<h3>"+heading+"</h3></div>"}if(z){B+='<div class="modal-body">';if(!D){B+='<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>'}B+=z+"</div>"}B+='<div class="modal-footer"><button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>';if(A){B+='<button class="btn btn-primary">'+A+"</button>"}B+="</div></div>";x[E]=b(B).on("click","button",function(F){x[E].modal("hide");g=true;n.focus();k(true);if(b(this).hasClass("btn-primary")){C()}}).on("shown",function(){g=true;b("textarea:first,input:first",x[E]).focus()});return x[E]};var w=function(){c.bold=new j("bold",null,["b","strong"],{"font-weight":"800"},["Ctrl-B"],null);c.italic=new j("italic",null,["i","em"],{"font-style":"italic"},["Ctrl-I"],null);c.underline=new j("underline",null,["u"],{"text-decoration":"underline"},["Ctrl-U"],null);c.strikeThrough=new j("strikeThrough",null,["s","strike"],{"text-decoration":"line-through"},["Ctrl-S"],null);c.justifyLeft=new j("justifyLeft",null,null,{"text-align":"left"},["Ctrl-L"],null);c.justifyRight=new j("justifyRight",null,null,{"text-align":"right"},["Ctrl-R"],null);c.justifyCenter=new j("justifyCenter",null,null,{"text-align":"center"},["Ctrl-E"],null);c.justifyFull=new j("justifyFull",null,null,{"text-align":"justify"},["Ctrl-J"],null);c.createLink=new j("createLink",null,["a"],null,["Ctrl-K"],r);c.unlink=new j("unlink",null,null,null,null,null);c.indent=new j("indent",null,null,null,null,null);c.outdent=new j("outdent",null,null,null,null,null);c.insertOrderedList=new j("insertOrderedList",null,["ol"],null,null,null);c.insertUnorderedList=new j("insertUnorderedList",null,["ul"],null,null,null);c.paragraph=new j("FormatBlock",((b.browser.msie||b.browser.webkit)?"<p>":"p"),["p"],null,null,null);for(var z=1;z<=6;z++){c["h"+z]=new j(((b.browser.msie||b.browser.webkit)?"FormatBlock":"heading"),((b.browser.msie||b.browser.webkit)?"<h"+z+">":"h"+z),["h"+z],null,null,null)}c.horizontalLine=new j("insertHorizontalRule",null,["hr"],null,null,null);c.insertImage=new j("insertImage",null,["img"],null,null,l);c.insertTable=new j(null,null,["table"],null,null,v.insertTable);c.insertRowBelow=new j(null,null,null,null,null,v.insertRowBelow);c.insertRowAbove=new j(null,null,null,null,null,v.insertRowAbove);c.insertColLeft=new j(null,null,null,null,null,v.insertColLeft);c.insertColRight=new j(null,null,null,null,null,v.insertColRight);c.deleteRow=new j(null,null,null,null,null,v.deleteRow);c.deleteCol=new j(null,null,null,null,null,v.deleteCol);c.deleteTable=new j(null,null,null,null,null,v.deleteTable);c.viewHtml=new j(null,null,null,null,null,f);b.each(c,function(E,H){if(!H.hotkey){return}for(var G=0;G<H.hotkey.length;G++){var F=H.hotkey[G].toUpperCase().split("-");var B=0;for(var D=0;D<F.length;D++){if(F[D]=="CTRL"){B|=256}else{if(F[D]=="ALT"){B|=512}else{if(F[D]=="SHIFT"){B|=1024}else{if(F[D]=="."){B|=190}else{if(F[D]==","){B|=188}else{var A=F[D].charCodeAt(0);if((A>=48&&A<=57)||(A>=65&&A<=90)){if(F[D].length==1){B|=A}else{if(F[D][0]=="F"){var C=parseInt(F[D].substring(1))||0;if(C>=1&&C<=12){B|=111+C}}}}}}}}}}h[B]=E}})};var s=function(A){var z=c[A];if(z.execCmd){z.execCmd.apply(this)}else{try{n.frameDoc.execCommand(z.command,false,z.value)}catch(B){console.error(B)}}q(null)};var q=function(z){u=u||y.getToolbar().find("div > ul > li:not(.divider,.divider-vertical,.dropdown)");b.each(u,function(){var A=b(this);var C=A.attr("actionKey");var B=c[C].command;if(B&&n.frameDoc.queryCommandState&&n.frameDoc.queryCommandState(B)){A.addClass("active")}else{A.removeClass("active")}})};var p=function(D,E,C){var B=b('<iframe id="bootstrapEditorFrame" frameBorder="0" id="myFrame"></iframe>');var G=b("<p style='color:#ccc' id='content-placeholder'>Type something...</p>");var z=b("<p>"+D+"</p>");this.frameDoc=null;var H=this;this.savedRange=null;var F=function(){if(H.frameDoc&&"designMode" in H.frameDoc){H.frameDoc.designMode="on"}else{if(H.frameDoc.body&&"contentEditable" in H.frameDoc.body){H.frameDoc.body.contentEditable=true}}};this.getSelection=function(){return B[0].contentWindow.getSelection?B[0].contentWindow.getSelection():(H.frameDoc?H.frameDoc.selection:null)};this.getFrame=function(){return B};this.getRange=function(){var I=this.getSelection();if(!I){return null}return I.createRange?I.createRange():((I.rangeCount&&I.rangeCount>0)?I.getRangeAt(0):frameDoc.createRange())};this.getText=function(){var I=this.getSelection();if(!I){return null}return I.createRange?I.createRange().text:I.toString()};this.selectNode=function(K,L){var I=n.getRange();if(!I){return}if(I.selectNodeContents){var J=n.getSelection();I.selectNodeContents(K);if(L){I.collapse(true)}J.removeAllRanges();J.addRange(I)}else{I.moveToElementText(K);if(L){I.collapse(true)}I.select()}};this.replaceText=function(K){var I=this.getRange();if(!I){return}if(I.insertNode){var J=this.getSelection();I.deleteContents();I.insertNode(K);I.selectNodeContents(K);J.removeAllRanges();J.addRange(I)}else{if(I.pasteHTML){I.pasteHTML(K.nodeValue);I.moveStart("character",K.nodeValue.length*-1);I.select()}}};this.insertNode=function(I){var J=this.getRange();if(!J){return}if(J.insertNode){var K=this.getSelection();J.deleteContents();J.insertNode(b(I)[0])}else{if(J.pasteHTML){J.pasteHTML(I)}}};this.changeSelection=function(K){if(B[0].contentWindow.getSelection){var J=B[0].contentWindow.getSelection();var I=this.frameDoc.createRange();I.selectNodeContents(K);J.removeAllRanges();J.addRange(I)}else{if(this.frameDoc.body.createTextRange){var I=this.frameDoc.body.createTextRange();I.moveToElementText(K);I.select()}}};this.checkFrameBodyEmpty=function(){var I=b(H.frameDoc.body).children("*:not(#content-placeholder)");return I.length==0||(I.length==1&&b(I[0]).find("ol,ul,li,hr,img,table,img,a").length==0&&!(b(I[0]).text()))};this.setFrameBodyContent=function(I){var J=b(H.frameDoc.body).find("*:first");if(I){J.html(G.html()).removeAttr("style").css("color","#CCC").attr("id","content-placeholder")}else{J.html(z.html()).removeAttr("id").removeAttr("style")}};var A=function(){B.width(E);B.height(C);F();b(H.frameDoc).on("click keyup",function(I){q(I.target?I.target:I.srcElement);return true});b(H.frameDoc).on("keydown",function(J){if((J.which>=65&&J.which<=90)||(J.which>=48&&J.which<=57)||(J.which==188||J.which==190)||(J.which>=112&&J.which<=123)){var I=J.which;if(J.altKey||J.ctrlKey||J.shiftKey||(J.which>=112&&J.which<=123)){I|=J.ctrlKey?256:0;I|=J.altKey?512:0;I|=J.shiftKey?1024:0;if(I in h){s(h[I]);J.preventDefault();J.stopPropagation()}}}if(J.which==8&&H.checkFrameBodyEmpty()){J.stopPropagation();return false}});b(B[0].contentWindow).on("focus",function(){g=true;k(true)}).on("blur",function(){g=false;k(false)});b(H.frameDoc).on("beforedeactivate blur",function(){H.savedRange=H.getRange()})};this.focus=function(){B[0].contentWindow.focus();if(this.savedRange){if(B[0].contentWindow.getSelection){var I=this.getSelection();I.removeAllRanges();I.addRange(this.savedRange)}else{if(this.frameDoc.selection){this.savedRange.select()}}}return true};this.addToElem=function(J){B[0].src="javascript:void(0)";J.append(B);this.frameDoc=B[0].contentDocument?B[0].contentDocument:(B[0].contentWindow?B[0].contentWindow.document:null);var I='<!DOCTYPE html><html><head><style>p{margin:16px 0px}</style></head><body style="overflow-x:hidden;word-wrap:break-word"><p style="color:#ccc" id="content-placeholder">Type something...</p></body></html>';this.frameDoc.open("text/html","replace");this.frameDoc.write(I);this.frameDoc.close();A()}};var m=function(){var G=this.menu=[];var F=null;var A=this;var C=function(I,H,J){H[I]=J};var z=function(H){var I="class='"+(H?"divider-vertical":"divider")+"'";return"<li "+I+"></li>"};var E=function(K,J){var L=K.action?("actionKey='"+K.action+"' "):"";var H=(K.title)?("title='"+K.title+(K.action&&c[K.action].hotkey?" ("+c[K.action].hotkey[0]+")":"")+"' "):"";var M=J?('<i class="'+K.icon+'"></i>'):("<i>"+K.title+"</i>");M=K.wrapContent?b(M).wrap("<div>"+K.wrapContent+"</div>").parents().last().html():M;var I="<li "+L+H+">";I+='<a href="#">'+M+"</a>";I+="</li>";return I};var B=function(){var I,H;I=0;C(I++,G,new d("icon-external-link",0,"View HTML Source",true,null,"viewHtml",null));C(I++,G,new d("icon-font",1,"Formatting",true,null,null,new Array()));H=0;C(H++,G[I-1].subMenu,new d(null,2,"Paragraph",true,"<p />","paragraph",null));while(H<=6){C(H++,G[I-1].subMenu,new d(null,2,"Header "+(H-1),true,"<h"+(H-1)+" />","h"+(H-1),null))}C(I++,G,new d("icon-bold",3,"Bold",true,null,"bold",null));C(I++,G,new d("icon-italic",3,"Italic",true,null,"italic",null));C(I++,G,new d("icon-underline",3,"Underline",true,null,"underline",null));C(I++,G,new d("icon-strikethrough",3,"StrikeThrough",true,null,"strikeThrough",null));C(I++,G,new d("icon-tasks",4,"Alignment",true,null,null,new Array()));H=0;C(H++,G[I-1].subMenu,new d("icon-align-left",5,"Align Text Left",true,null,"justifyLeft",null));C(H++,G[I-1].subMenu,new d("icon-align-right",5,"Align Text Right",true,null,"justifyRight",null));C(H++,G[I-1].subMenu,new d("icon-align-center",5,"Center",true,null,"justifyCenter",null));C(H++,G[I-1].subMenu,new d("icon-align-justify",6,"Justify",true,null,"justifyFull",null));C(I++,G,new d("icon-indent-left",7,"Increase Indent",true,null,"indent",null));C(I++,G,new d("icon-indent-right",7,"Decrease Indent",true,null,"outdent",null));C(I++,G,new d("icon-list-ul",7,"Bullets",true,null,"insertUnorderedList",null));C(I++,G,new d("icon-list-ol",7,"Numbering",true,null,"insertOrderedList",null));C(I++,G,new d("icon-link",8,"Link",true,null,null,new Array()));H=0;C(H++,G[I-1].subMenu,new d(null,9,"Link",true,null,"createLink",null));C(H++,G[I-1].subMenu,new d(null,9,"Unlink",true,null,"unlink",null));C(I++,G,new d("icon-minus",8,"Insert Horizontal Line",true,null,"horizontalLine",null));C(I++,G,new d("icon-picture",8,"Insert Image",true,null,"insertImage",null));C(I++,G,new d("icon-table",8,"Table",true,null,"insertTable",new Array()));H=0;C(H++,G[I-1].subMenu,new d(null,10,"Insert Table",true,null,"insertTable",null));C(H++,G[I-1].subMenu,new d(null,11,"Add Row Above",true,null,"insertRowAbove",null));C(H++,G[I-1].subMenu,new d(null,11,"Add Row Below",true,null,"insertRowBelow",null));C(H++,G[I-1].subMenu,new d(null,11,"Add Column Right",true,null,"insertColRight",null));C(H++,G[I-1].subMenu,new d(null,11,"Add Column Left",true,null,"insertColLeft",null));C(H++,G[I-1].subMenu,new d(null,12,"Delete Row",true,null,"deleteRow",null));C(H++,G[I-1].subMenu,new d(null,12,"Delete Column",true,null,"deleteCol",null));C(H++,G[I-1].subMenu,new d(null,12,"Delete Table",true,null,"deleteTable",null))};var D=function(){B();var K="<div id='bootstrapEditorToolbar' class='navbar navbar-inverse'><div class='navbar-inner'><ul class='nav'>";for(var J=0;J<G.length;J++){if(J>0&&G[J].group!=G[J-1].group){K+=z(true)}if(G[J].subMenu){var H=(G[J].title)?("title='"+G[J].title+"' "):"";K+='<li class="dropdown" '+H+">";K+='<a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="'+G[J].icon+'"></i></a>';K+='<ul class="dropdown-menu">';for(var I=0;I<G[J].subMenu.length;I++){if(I>0&&G[J].subMenu[I].group!=G[J].subMenu[I-1].group){K+=z(false)}K+=E(G[J].subMenu[I],false)}K+="</ul></li>"}else{K+=E(G[J],true)}}K+="</ul></div></div>";return K};this.getToolbar=function(){F=F||b(D());return F};this.addToElem=function(H){H.append(this.getToolbar());this.getToolbar().on("click","li:not(.divider,.divider-vertical,.dropdown)",function(I){var J=b(this).attr("actionKey");g=true;this.blur();n.focus();k(true);s(J);return true})}};var g=false;var e=false;var t=function(){if(e!=g){i.toggleClass("onfocus",g);if(n.checkFrameBodyEmpty()){n.setFrameBodyContent(!g)}e=g}};var k=function(z){if(!z){setTimeout(function(){t()},200)}else{t()}};this.init=function(B){var A=B.width()||640;var z=B.height()||340;w();B.addClass("bootstrapEditor");B.attr("tabindex","0");i=B;i.width(A);i.height(z);y=new m();y.addToElem(i);n=new p("<br>",A,z-y.getToolbar().height());n.addToElem(i);i.on("focus",function(C){g=true;this.blur();n.focus()}).on("blur",function(C){g=false;k(false)})}}b.fn.bootstrapEditor=function(){var c=new a();c.init(this)}})(jQuery);
